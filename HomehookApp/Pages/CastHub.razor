@page "/"

<div class="row m-0 w-100">
    <h2 class="col m-2 p-0 text-stroke">Homehook Cast Hub</h2>
    <i class="col d-flex align-items-center button-bright justify-content-end m-2 p-0 mdi mdi-refresh mdi-36px" @onclick="RefreshReceivers"></i>
</div>

@if (_receiverHub == null || _receiverHub.State != HubConnectionState.Connected)
{
    <BusyCover />
}
else
{
    <div class="d-flex flex-wrap">
        @foreach (string receiver in _receivers)
        {
            <Receiver Name=@receiver />
        }
    </div>
}


@code{

    private IEnumerable<string> _receivers;
    private HubConnection _receiverHub;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        _receiverHub = new HubConnectionBuilder()
            .WithUrl(new Uri("http://localhost:5000/receiverhub"))
            .AddNewtonsoftJsonProtocol()
            .WithAutomaticReconnect()
            .Build();

        await _receiverHub.StartAsync();

        _receivers = await _receiverHub.InvokeAsync<IEnumerable<string>>("GetReceivers");
    }

    protected async Task RefreshReceivers(MouseEventArgs _)
    {
        await _receiverHub.InvokeAsync<IEnumerable<string>>("RefreshReceivers");
        _receivers = await _receiverHub.InvokeAsync<IEnumerable<string>>("GetReceivers");
        await InvokeAsync(StateHasChanged);
    }

}
